<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket;
        var sourceVideo;
        var remoteVideo;
        var localStream;
        var pc;
        var started;
        var host = true;


        document.addEventListener('DOMContentLoaded', function () {
            socket = io.connect('http://localhost');

            socket.on('msg', function (data) {
                console.log(data);
                processSignalingMessage(data);
            });

            sourceVideo = document.getElementById("source");
            remoteVideo = document.getElementById("remote");

            navigator.webkitGetUserMedia({audio:true, video:true}, successCallback, errorCallback);

            sourceVideo.addEventListener('success', function () {
                console.log('getUserMedia success');

                if (host) start();
            });

        }, false);

        function call() {
            console.log("call");
            var offer = pc.createOffer({audio:true, video:true});
            pc.setLocalDescription(pc.SDP_OFFER, offer);
            sendMessage({type:'offer', sdp:offer.toSdp()});
            pc.startIce();
        }

        function start() {
            console.log("start");
            if (!started && localStream) {
                createPeerConnection();
                pc.addStream(localStream);
                started = true;

                if (host) {
                    call();
                }
            }
        }

        function answer() {
            console.log("answer");
            var offer = pc.remoteDescription;
            var answer = pc.createAnswer(offer.toSdp(), {audio:true, video:true});
            pc.setLocalDescription(pc.SDP_ANSWER, answer);
            sendMessage({type:'answer', sdp:answer.toSdp()});
            pc.startIce();
        }


        function onIceCandidate(candidate, moreToFollow) {
            if (candidate) {
                sendMessage({type:'candidate',
                    label:candidate.label, candidate:candidate.toSdp()});
            }

            if (!moreToFollow) {
                console.log("End of candidates.");
            }
        }

        function processSignalingMessage(msg) {
            if (msg.type === 'offer') {
                console.log("offer recieved");
                // Callee creates PeerConnection
                if (!host && !started) start();

                pc.setRemoteDescription(pc.SDP_OFFER, new SessionDescription(msg.sdp));
                answer();
            } else if (msg.type === 'answer' && started) {
                pc.setRemoteDescription(pc.SDP_ANSWER, new SessionDescription(msg.sdp));
            } else if (msg.type === 'candidate' && started) {
                var candidate = new IceCandidate(msg.label, msg.candidate);
                pc.processIceMessage(candidate);
            } else if (msg.type === 'bye' && started) {
                onRemoteHangup();
            }
        }

        function sendMessage(message) {
            console.log('C->S: ', message);
            socket.emit('message', message);
        }

        function createPeerConnection() {
            console.log('creating peer connection');

            try {
                pc = new webkitPeerConnection00("STUN stun.l.google.com:19302", onIceCandidate);
            }
            catch (e) {
                console.log('error', e);
            }

            pc.onconnecting = onSessionConnecting;
            pc.onopen = onSessionOpened;
            pc.onaddstream = onRemoteStreamAdded;
            pc.onremovestream = onRemoteStreamRemoved;
        }


        function onMessage(evt) {
            // Message returned from other side
            console.log('message recieved');
            pc.processSignalingMessage(evt.data);
        }


        function successCallback(stream) {
            var url = webkitURL.createObjectURL(stream);
            sourceVideo.src = url;
            localStream = stream;

            var evt = document.createEvent('Event');
            evt.initEvent('success', true, true);
            sourceVideo.dispatchEvent(evt);
        }

        function errorCallback(error) {
            console.error('An error occurred: [CODE ' + error.code + ']');
        }

        // when PeerConn is created, send setup data to peer via WebSocket
        function onSignal(message) {
            console.log('sending message', message);
            //ws.send(message);
        }

        // when remote adds a stream, hand it on to the local video element
        function onRemoteStreamAdded(event) {
            remoteVideo.src = window.webkitURL.createObjectURL(event.stream);
        }

        // when remote removes a stream, remove it from the local video element
        function onRemoteStreamRemoved(event) {
            remoteVideo.src = "";
        }

        function onSessionConnecting(message) {
            console.log("Session connecting.");
        }
        function onSessionOpened(message) {
            console.log("Session opened.");
        }

    </script>
</head>
<body>

<video id="source" autoplay="autoplay"></video>
<video id="remote" autoplay="autoplay"></video>

</body>
</html>